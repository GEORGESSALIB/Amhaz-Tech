{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>{% block title %}Amhaz Tech{% endblock %}</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --primary: #2563eb;
  --text-main: #0f172a;
  --text-muted: #64748b;
  --silver-100: #f8fafc;
  --silver-200: #f1f5f9;
  --silver-300: #e5e7eb;
  --shadow-soft: 0 30px 60px rgba(0,0,0,.08);
}

body {
  font-family: Inter, system-ui, sans-serif;
  background: linear-gradient(180deg, #fff, var(--silver-100));
  color: var(--text-main);
  margin: 0;
}

/* ================= TOPBAR ================= */
.topbar {
  height: 74px;
  background: rgba(255,255,255,.94);
  backdrop-filter: blur(14px);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 2rem;
  border-bottom: 1px solid var(--silver-300);
  position: sticky;
  top: 0;
  z-index: 1000;
}

/* ================= BRAND ================= */
.top-brand {
  display: flex;
  align-items: center;
  gap: 1rem;
  text-decoration: none;
  color: inherit;
}

.top-brand img {
  width: 56px;
  height: 56px;
  border-radius: 14px;
}

.top-brand strong {
  font-size: 1.25rem;
  font-weight: 800;
}

/* ================= SEARCH ================= */
.search-bar {
  width: 420px;
  position: relative;
}

.search-bar input {
  width: 100%;
  height: 44px;
  border-radius: 999px;
  border: 1px solid var(--silver-300);
  padding: 0 3rem 0 1.2rem;
}

.search-bar button {
  position: absolute;
  right: 6px;
  top: 50%;
  transform: translateY(-50%);
  border: none;
  background: linear-gradient(135deg, #2563eb, #1e40af);
  color: white;
  height: 34px;
  width: 34px;
  border-radius: 50%;
}

/* ================= CATEGORIES ================= */
.nav-dropdown .dropdown-menu {
  border-radius: 18px;
  padding: 1.2rem;
  box-shadow: var(--shadow-soft);
  border: none;
}

.nav-dropdown a {
  display: block;
  padding: .45rem .6rem;
  border-radius: 10px;
  text-decoration: none;
  color: var(--text-main);
}

.nav-dropdown a:hover {
  background: rgba(37,99,235,.08);
  color: var(--primary);
}

/* ================= CART ================= */
#cartIcon {
  position: relative;
  display: flex;
  align-items: center;
  gap: .5rem;
  padding: .55rem 1.2rem;
  border-radius: 999px;
  background: linear-gradient(135deg, #2563eb, #1e40af);
  color: white;
  text-decoration: none;
}

#cartCount {
  position: absolute;
  top: -6px;
  right: -6px;
  background: #ef4444;
  font-size: .7rem;
  padding: .15rem .45rem;
  border-radius: 999px;
}

/* ================= AUTH ================= */
.auth-btn {
  padding: .45rem 1.2rem;
  border-radius: 999px;
  font-weight: 600;
}

.auth-login {
  border: 1px solid var(--silver-300);
  background: white;
}

.auth-signup {
  background: linear-gradient(135deg, #2563eb, #1e40af);
  color: white;
  border: none;
}

/* ================= ADMIN ================= */
.admin-btn {
  background: var(--silver-200);
  border-radius: 999px;
  padding: .45rem .9rem;
  border: none;
}

.admin-menu {
  min-width: 220px;
  border-radius: 18px;
  box-shadow: var(--shadow-soft);
  border: none;
  padding: .6rem;
}

.admin-menu a {
  display: flex;
  align-items: center;
  gap: .6rem;
  padding: .55rem .75rem;
  border-radius: 12px;
  text-decoration: none;
  color: var(--text-main);
  font-weight: 500;
}

.admin-menu a:hover {
  background: rgba(37,99,235,.08);
  color: var(--primary);
}

/* ================= MAIN ================= */
main {
  padding: 2.2rem;
}

/* ================= MOBILE ================= */
@media (max-width: 992px) {
  .search-bar { display: none; }
}

/* ================= WHATSAPP ================= */
.whatsapp-btn {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background-color: #25D366;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 6px 18px rgba(0,0,0,0.2);
  z-index: 1100;
  text-decoration: none;
}
/* ================= ADD TO CART FLY ANIMATION (BALANCED) ================= */

.fly-img {
  position: fixed;
  object-fit: cover;
  border-radius: 12px;
  pointer-events: none;
  z-index: 3000;
  will-change: transform, opacity;
}

/* refined bounce (strong but not cartoon) */
.cart-bounce {
  animation: cartBounce .32s cubic-bezier(.34,1.56,.64,1);
}

@keyframes cartBounce {
  0%   { transform: scale(1); }
  40%  { transform: scale(1.18); }
  70%  { transform: scale(0.97); }
  100% { transform: scale(1); }
}


</style>
</head>

<body>

<!-- SIDEBAR (KEPT EMPTY FOR JS SAFETY) -->
<div id="sidebar" style="display:none;"></div>

<!-- CONTENT -->
<div id="mainContent" class="content full">

  <!-- TOPBAR -->
  <div class="topbar">

    <!-- BRAND -->
    <a href="{% url 'home' %}" class="top-brand">
      <img src="{% static 'images/logo.jpeg' %}">
      <strong>Amhaz Tech</strong>
    </a>

    <!-- SEARCH -->
    <form method="get" action="{% url 'product_search' %}" class="search-bar">
      <input type="text" name="q" placeholder="Search products..." value="{{ search_query|default:'' }}">
      <button><i class="bi bi-search"></i></button>
    </form>

    <!-- RIGHT -->
    <div class="d-flex align-items-center gap-3">

      <!-- CATEGORIES -->
      <div class="dropdown nav-dropdown">
        <button class="btn btn-light dropdown-toggle" data-bs-toggle="dropdown">
          Categories
        </button>
        <div class="dropdown-menu">
          {% for category in nav_categories %}
            <strong class="d-block mb-1">{{ category.name }}</strong>
            {% for sub in category.active_subcategories %}
              <a href="{% url 'products_by_subcategory' sub.id %}">{{ sub.name }}</a>
            {% endfor %}
            <hr>
          {% endfor %}
        </div>
      </div>

      <!-- CART -->
      <a href="{% url 'cart_view' %}" id="cartIcon">
        <i class="bi bi-basket3-fill"></i>
        <span id="cartCount">{{ cart_count }}</span>
      </a>

      <!-- AUTH / ADMIN -->
      {% if user.is_authenticated %}
        <div class="dropdown">
          <button class="admin-btn dropdown-toggle" data-bs-toggle="dropdown">
            <i class="bi bi-gear"></i>
          </button>
          <div class="dropdown-menu dropdown-menu-end admin-menu">
            {% if request.user.is_staff %}
              <a href="{% url 'category_list' %}"><i class="bi bi-folder2-open"></i> Categories</a>
              <a href="{% url 'dashboard' %}"><i class="bi bi-speedometer2"></i> Dashboard</a>
              <a href="{% url 'confirmed_orders' %}"><i class="bi bi-check2-square"></i> Orders</a>
              <hr>
            {% endif %}
            <form method="post" action="{% url 'logout' %}">
              {% csrf_token %}
              <button class="btn btn-outline-danger btn-sm w-100">Logout</button>
            </form>
          </div>
        </div>
      {% else %}
        <a href="{% url 'login' %}" class="auth-btn auth-login">Login</a>
        <a href="{% url 'signup' %}" class="auth-btn auth-signup">Sign up</a>
      {% endif %}
    </div>
  </div>

  <main>{% block content %}{% endblock %}</main>
</div>

<!-- WHATSAPP -->
<a href="https://wa.me/96179102926" target="_blank" class="whatsapp-btn">
  <i class="bi bi-whatsapp text-white fs-4"></i>
</a>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("click", (e) => {
  const btn = e.target.closest(".add-to-cart-btn");
  if (!btn) return;

  const form = btn.closest(".add-to-cart-form");
  const productId = form.dataset.productId;
  const csrfToken = form.querySelector("[name=csrfmiddlewaretoken]").value;

  const cart = document.getElementById("cartIcon");
  const card = btn.closest(".card");
  const img = card?.querySelector("img");

  /* ========= START RECT ========= */
  const startRect = (img || btn).getBoundingClientRect();
  const endRect = cart.getBoundingClientRect();

  const startX = startRect.left + startRect.width / 2;
  const startY = startRect.top + startRect.height / 2;

  const endX = endRect.left + endRect.width / 2;
  const endY = endRect.top + endRect.height / 2;

  const dx = endX - startX;
  const dy = endY - startY;

  /* ========= CREATE CLONE ========= */
  let clone;
  if (img) {
    clone = img.cloneNode(true);
  } else {
    clone = document.createElement("div");
    clone.innerHTML = '<i class="bi bi-basket3-fill"></i>';
    clone.style.display = "flex";
    clone.style.alignItems = "center";
    clone.style.justifyContent = "center";
    clone.style.background = "#f1f5f9";
    clone.style.color = "#2563eb";
    clone.style.fontSize = "22px";
  }

  clone.classList.add("fly-img");
  clone.style.left = startRect.left + "px";
  clone.style.top = startRect.top + "px";
  clone.style.width = startRect.width + "px";
  clone.style.height = startRect.height + "px";
  clone.style.boxShadow = "0 12px 25px rgba(0,0,0,.2)";
  clone.style.borderRadius = "12px";
  clone.style.transition = "transform 0.42s cubic-bezier(.22,.9,.3,1), opacity 0.42s ease-out";
  clone.style.opacity = "1";

  document.body.appendChild(clone);

  /* ========= ANIMATION ========= */
  requestAnimationFrame(() => {
    clone.style.transform = `translate(${dx}px, ${dy}px) scale(0.22)`;
    clone.style.opacity = "0.25";
  });

  /* ========= HANDLE CART BOUNCE + COUNTER ========= */
  clone.addEventListener("transitionend", () => {
    clone.remove();
    cart.classList.add("cart-bounce");

    // Only update counter after bounce
    fetch(`/order/add/${productId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": csrfToken,
        "X-Requested-With": "XMLHttpRequest"
      }
    })
    .then(r => r.ok ? r.json() : null)
    .then(data => {
      if (data) {
        document.getElementById("cartCount").textContent = data.cart_count;
      }
    });

    setTimeout(() => cart.classList.remove("cart-bounce"), 320);
  }, { once: true });
});
</script>







</body>
</html>