{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="mb-0">{{ subcategory.name }}</h2>

  {% if request.user.is_staff %}
    <a href="{% url 'product_add' subcategory.id %}"
       class="btn btn-outline-success">
      + Add Product
    </a>
  {% endif %}
</div>

<div class="row g-4">
  {% for product in products %}
  <div class="col-xl-3 col-lg-4 col-md-6">
    <div class="card h-100 shadow-sm border-0">

      {% if product.photo %}
      <img src="{{ product.photo.url }}"
           class="card-img-top"
           style="height: 180px; object-fit: cover;"
           alt="{{ product.name }}">
      {% endif %}

      <div class="card-body d-flex flex-column">

        <!-- Product name -->
        <h6 class="fw-semibold mb-1">{{ product.name }}</h6>

        <!-- Description -->
        <p class="text-muted small mb-2">
          {{ product.description|truncatechars:60 }}
        </p>

        <!-- Price -->
        <div class="mb-2">
          <span class="fs-5 fw-bold">${{ product.price }}</span>
        </div>

        <!-- Stock badge -->
        <div class="mb-3">
          {% if product.cached_quantity == 0 %}
            <span class="badge bg-danger">Out of stock</span>
          {% elif product.cached_quantity <= 10 %}
            <span class="badge bg-warning text-dark">Low stock</span>
          {% else %}
            <span class="badge bg-success">In stock</span>
          {% endif %}
        </div>

        <!-- STAFF ACTIONS -->
        {% if request.user.is_staff %}
          <div class="d-flex gap-2 mb-2">
            <a href="{% url 'product_edit' product.id %}"
               class="btn btn-sm btn-outline-primary w-50">
              Edit
            </a>
          </div>
        {% endif %}

        <!-- Spacer -->
        <div class="mt-auto"></div>

        <!-- CART CTA -->
        {% if product.cached_quantity > 0 %}
          <form method="post"
                action="{% url 'cart_add' product.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary w-100">
              Add to Cart
            </button>
          </form>
        {% else %}
          <button class="btn btn-secondary w-100" disabled>
            Unavailable
          </button>
        {% endif %}

      </div>
    </div>
  </div>
  {% empty %}
    <p class="text-muted">No products found in this category.</p>
  {% endfor %}
</div>

{% endblock %}
